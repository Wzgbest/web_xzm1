<header>
	<h1>合同申请<i class="fa fa-close fa-2x pop-close-btn"></i></h1>
</header>
<div class="pop_content m-form">
	<div class="main" id="create-apply-container">
		<div class="main-content">
			<div>
				<span class="cont">合同类型</span>
				<select class="type-class">
					<option></option>
					<option value="5">糯米类合同</option>
					<option value="4">建站类合同</option>
					<option value="3">百度地图类合同</option>
					<option value="2">百度百科类合同</option>
					<option value="1">百度大搜类合同</option>
				</select>
				<span class="cont">合同数量</span>
				<input type="text" class="contract-number"/>
			</div>
			<div>
				<span class="cont exam-man hide">一审人</span>
				<select class="exam-man-s hide">
					<option></option>
				</select >
				<span class="cont exam-man hide">二审人</span>
				<select class="exam-man-s hide">
					<option></option>
				</select>
			</div>
			<div>
				<span class="cont exam-man hide">三审人</span>
				<select class="exam-man-s hide">
					<option></option>
				</select>
				<span class="cont exam-man hide">四审人</span>
				<select class="exam-man-s hide">
					<option></option>
				</select>
			</div>
			<div>
				<span class="cont exam-man hide">五审人</span>
				<select class="exam-man-s hide">
					<option></option>
				</select>
				<span class="cont exam-man hide">六审人</span>
				<select class="exam-man-s hide">
					<option></option>
				</select>
			</div>
		</div>
	</div>
	<div class="add">
		<i class="fa fa-plus fa-2x color-blue"></i>
	</div>
	<div class="u-submitButton">
		<button class="pop-submit-btn">申请</button>
		<button class="pop-close-btn">取消</button>
	</div>
</div>
<link rel="stylesheet" href="/crm/css/popUp.css" />
<script>
	var exm = document.getElementsByClassName("exam-man");
	var m_c = document.getElementsByClassName("main-content");
	var len1 = exm.length;
	var contract_type_list_json = {
		"5":{"apply_1":6,"apply_2":null,"apply_3":null,"apply_4":null,"apply_5":null,"apply_6":null},
		"4":{"apply_1":6,"apply_2":null,"apply_3":null,"apply_4":null,"apply_5":null,"apply_6":null},
		"3":{"apply_1":6,"apply_2":null,"apply_3":null,"apply_4":null,"apply_5":null,"apply_6":null},
		"2":{"apply_1":6,"apply_2":null,"apply_3":null,"apply_4":null,"apply_5":null,"apply_6":null},
		"1":{"apply_1":6,"apply_2":5,"apply_3":4,"apply_4":2,"apply_5":1,"apply_6":null}
		};
	var role_employee_index = {
		"1":[{"user_id":1,"truename":"\u674e\u6d2a\u91d1"},{"user_id":6,"truename":"\u8096\u6587\u660c"},{"user_id":9,"truename":"\u674e\u534e\u5b9d"},{"user_id":11,"truename":"\u8463\u5029"}],
		"2":[{"user_id":1,"truename":"\u674e\u6d2a\u91d1"},{"user_id":2,"truename":"\u738b\u542f\u6587"},{"user_id":3,"truename":"\u66f9\u946b\u946b"},{"user_id":4,"truename":"\u5b59\u5927\u9e4f"},{"user_id":5,"truename":"\u5f20\u6653\u9633"},{"user_id":6,"truename":"\u8096\u6587\u660c"},{"user_id":7,"truename":"\u8d75\u5a67\u5f64"},{"user_id":8,"truename":"\u53f2\u5b66\u9e4f"},{"user_id":9,"truename":"\u674e\u534e\u5b9d"},{"user_id":10,"truename":"\u5f20\u96e8"},{"user_id":11,"truename":"\u8463\u5029"},{"user_id":72,"truename":"\u5458\u5de5\u7532"},{"user_id":85,"truename":"\u674e\u534e"},{"user_id":90,"truename":"\u5458\u5de5\u4e59"}],
		"4":[{"user_id":4,"truename":"\u5b59\u5927\u9e4f"}],
		"5":[{"user_id":5,"truename":"\u5f20\u6653\u9633"},{"user_id":10,"truename":"\u5f20\u96e8"},{"user_id":85,"truename":"\u674e\u534e"},{"user_id":90,"truename":"\u5458\u5de5\u4e59"}],
		"6":[{"user_id":72,"truename":"\u5458\u5de5\u7532"},{"user_id":85,"truename":"\u674e\u534e"}]
		};
	//合同类型选择事件
	$(document).on("change","#create-apply-container .type-class",function(){
		//点击的是哪一行的select
		var row = $(this).parents(".main-content").index();
		//改变后的合同类型的value
		var a = $(this).val()
		//value在contract_type_list_json里面对应的类
		var b = contract_type_list_json[a];
		//一个简单变量
		var c ;
		//计数器d
		var d = 0;
		//遍历类b
		for(c in b){
		//如果当前属性的值不是空
			if(b[c]){
				$(".main-content").eq(row).find(".exam-man").eq(d).removeClass("hide");
				$(".main-content").eq(row).find(".exam-man-s").eq(d).removeClass("hide");
				//当前属性值在role_employee_index里对应的数组
				var arr = role_employee_index[b[c]];
				$(".main-content").eq(row).find(".exam-man-s").eq(d).html("<option></option>");
				for(var i=0;i<arr.length;i++){					
					$(".main-content").eq(row).find(".exam-man-s").eq(d).append("<option value="+arr[i].user_id+">"+arr[i].truename+"</option>");
				}
				d++;
			}else{
				break;
			}			
		};
		for(d;d<len1;d++){
				$(".main-content").eq(row).find(".exam-man").eq(d).addClass("hide");
				$(".main-content").eq(row).find(".exam-man-s").eq(d).addClass("hide");
		}	
	});

//add按钮事件	
	var t = $("#create-contract .main-content").html();
	$("#create-contract .add").click(function(){
		//小于合同类型的数量
		if(m_c.length<5){
			var div = document.createElement("div");
			div.setAttribute("class","main-content");
			div.innerHTML = t;
			document.getElementById("create-apply-container").appendChild(div);
		}else{
			alert("不能再添加了");
		}		
	});
	function Contract(type,num,apply_num){
		this.type = type,
		this.num = num
	}
	$(document).on("click",".pop-submit-btn",function(){
		var arry = new Array(m_c.length);
		console.log(arry);
		for(var i=0;i<m_c.length;i++){
			var m = $(".main-content").eq(i);
			var val1 = m.find(".type-class").val();
			var val2 = m.find(".contract-number").val();
			var exms = m.find(".exam-man-s").not(".hide");
			
			console.log(val1,val2,exms.length);
			var contract = new Contract(val1,val2,exms.length)
			arry[i] = "";
			for(var j=1;j<=exms.length;j++){
				contract["apply_"+j] = exms.eq(j-1).val();
			}
			arry[i] = contract;
		}
		console.log(arry);
		$.ajax({
	        url: '/crm/contract/apply',
	        type: 'post',
	        data: JSON.stringify(arry),
	        success: function(data) {
	            alert("申请成功");
	            $("#create-contract").addClass("hide");
	        },
	        error: function() {
	            alert("申请时发生错误!");
	        }
	    });

	});
</script>